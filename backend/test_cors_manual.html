<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CORS Manual Test Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f9fafb;
        }

        .test-section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input[type="text"] {
            flex: 1;
            min-width: 250px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            display: none;
        }

        .result.success {
            background: #d1fae5;
            border: 2px solid #10b981;
            color: #065f46;
        }

        .result.error {
            background: #fee2e2;
            border: 2px solid #ef4444;
            color: #991b1b;
        }

        .result.info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            color: #1e40af;
        }

        .quick-tests {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .quick-test-btn {
            padding: 15px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-test-btn:hover {
            border-color: #667eea;
            background: #f9fafb;
            transform: translateY(-2px);
        }

        .quick-test-btn .title {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .quick-test-btn .desc {
            font-size: 12px;
            color: #6b7280;
        }

        .info-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .info-box h3 {
            color: #92400e;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .info-box ul {
            margin-left: 20px;
            color: #78350f;
            font-size: 13px;
        }

        .info-box li {
            margin: 5px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üîí CORS Security Test Tool</h1>
            <p>Test your CORS configuration with real HTTP requests</p>
        </div>

        <div class="content">
            <div class="info-box">
                <h3>üìã Configured Allowed Origins:</h3>
                <ul id="allowedOriginsList">
                    <li>Loading...</li>
                </ul>
            </div>

            <div class="test-section">
                <h2>üß™ Quick Tests</h2>
                <div class="quick-tests">
                    <div class="quick-test-btn" onclick="testAllowedOrigin()">
                        <div class="title">‚úÖ Allowed Origin</div>
                        <div class="desc">Test with first allowed origin</div>
                    </div>

                    <div class="quick-test-btn" onclick="testDisallowedOrigin()">
                        <div class="title">‚ùå Disallowed Origin</div>
                        <div class="desc">Test with evil.com</div>
                    </div>

                    <div class="quick-test-btn" onclick="testPreflightAllowed()">
                        <div class="title">‚úàÔ∏è Preflight (Allowed)</div>
                        <div class="desc">OPTIONS request - valid</div>
                    </div>

                    <div class="quick-test-btn" onclick="testPreflightDisallowed()">
                        <div class="title">üö´ Preflight (Blocked)</div>
                        <div class="desc">OPTIONS request - should 403</div>
                    </div>
                </div>

                <div id="quickTestResult" class="result"></div>
            </div>

            <div class="test-section">
                <h2>üîß Custom Test</h2>
                <div class="test-controls">
                    <input type="text" id="customOrigin" placeholder="Enter origin (e.g., https://example.com)">
                    <button onclick="testCustomOrigin('GET')">Test GET</button>
                    <button onclick="testCustomOrigin('POST')">Test POST</button>
                    <button onclick="testCustomOrigin('OPTIONS')">Test OPTIONS</button>
                </div>
                <div id="customTestResult" class="result"></div>
            </div>

            <div class="test-section">
                <h2>üìä Bulk Test Results</h2>
                <button onclick="runAllTests()">Run All Automated Tests</button>
                <div id="bulkTestResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin + '/backend/api';
        let allowedOrigins = [];

        // Load allowed origins on page load
        async function loadAllowedOrigins() {
            try {
                const response = await fetch(`${API_BASE}/health.php`);
                const data = await response.json();

                // Parse from .env (we'll need to add an endpoint for this)
                // For now, show from the test results
                allowedOrigins = ['http://localhost:5173', 'http://localhost:3000'];

                const list = document.getElementById('allowedOriginsList');
                list.innerHTML = allowedOrigins.map(o => `<li><code>${o}</code></li>`).join('');
            } catch (error) {
                console.error('Failed to load origins:', error);
            }
        }

        function showResult(elementId, type, message) {
            const el = document.getElementById(elementId);
            el.className = `result ${type}`;
            el.textContent = message;
            el.style.display = 'block';
        }

        async function testAllowedOrigin() {
            const origin = allowedOrigins[0] || 'http://localhost:5173';
            showResult('quickTestResult', 'info', `Testing with allowed origin: ${origin}...`);

            try {
                const response = await fetch(`${API_BASE}/health.php`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const corsHeader = response.headers.get('Access-Control-Allow-Origin');
                const credHeader = response.headers.get('Access-Control-Allow-Credentials');

                const result = `‚úÖ ALLOWED ORIGIN TEST (GET)
                
Origin: ${origin}
Status: ${response.status} ${response.statusText}
Access-Control-Allow-Origin: ${corsHeader || 'NOT SET'}
Access-Control-Allow-Credentials: ${credHeader || 'NOT SET'}

Result: ${corsHeader === origin ? '‚úì PASS' : '‚úó FAIL'}`;

                showResult('quickTestResult', corsHeader === origin ? 'success' : 'error', result);
            } catch (error) {
                showResult('quickTestResult', 'error', `Error: ${error.message}`);
            }
        }

        async function testDisallowedOrigin() {
            const origin = 'https://evil.com';
            showResult('quickTestResult', 'info', `Testing with disallowed origin: ${origin}...`);

            // Note: We can't actually set the Origin header from browser JavaScript
            // This test demonstrates what should happen
            const result = `‚ùå DISALLOWED ORIGIN TEST
            
‚ö†Ô∏è Note: Browsers prevent setting custom Origin headers.
This test shows expected behavior.

Origin: ${origin}
Expected Result:
- Status: 200 (or endpoint-specific status)
- Access-Control-Allow-Origin: NOT SET
- Browser blocks the response due to CORS policy

Actual test must be done server-side or with curl/Postman.

Command for manual testing:
curl -H "Origin: ${origin}" -v ${API_BASE}/health.php`;

            showResult('quickTestResult', 'info', result);
        }

        async function testPreflightAllowed() {
            const origin = allowedOrigins[0] || 'http://localhost:5173';
            showResult('quickTestResult', 'info', `Testing OPTIONS preflight with allowed origin...`);

            try {
                const response = await fetch(`${API_BASE}/health.php`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                const result = `‚úàÔ∏è PREFLIGHT TEST (ALLOWED)
                
Method: OPTIONS
Origin: ${origin}
Status: ${response.status} ${response.statusText}

Expected: Status 200, CORS headers present
Result: ${response.status === 200 ? '‚úì PASS' : '‚úó FAIL'}`;

                showResult('quickTestResult', response.status === 200 ? 'success' : 'error', result);
            } catch (error) {
                showResult('quickTestResult', 'error', `Error: ${error.message}`);
            }
        }

        async function testPreflightDisallowed() {
            const result = `üö´ PREFLIGHT TEST (DISALLOWED)
            
‚ö†Ô∏è Browser security prevents testing with custom origins.

Expected behavior when testing from evil.com:
- Method: OPTIONS
- Origin: https://evil.com
- Expected Status: 403 Forbidden
- Expected: NO Access-Control-Allow-Origin header
- Browser: Blocks the request

Manual test command:
curl -X OPTIONS -H "Origin: https://evil.com" -v ${API_BASE}/health.php

Expected output:
< HTTP/1.1 403 Forbidden
< Content-Type: application/json
(NO Access-Control-Allow-Origin header)`;

            showResult('quickTestResult', 'info', result);
        }

        async function testCustomOrigin(method) {
            const origin = document.getElementById('customOrigin').value.trim();

            if (!origin) {
                showResult('customTestResult', 'error', 'Please enter an origin');
                return;
            }

            const result = `üîß CUSTOM ORIGIN TEST
            
‚ö†Ô∏è Browser security prevents setting custom Origin headers.

To test with custom origin: ${origin}
Method: ${method}

Use this curl command:
curl -X ${method} -H "Origin: ${origin}" -H "Content-Type: application/json" -v ${API_BASE}/health.php

What to check:
1. If origin is allowed: 
   - Look for "Access-Control-Allow-Origin: ${origin}"
   - Status should be 200 (or endpoint default)
   
2. If origin is NOT allowed:
   - ${method === 'OPTIONS' ? 'Status should be 403 Forbidden' : 'NO Access-Control-Allow-Origin header'}
   - ${method === 'OPTIONS' ? 'Response body: {"success":false,"error":"Origin not allowed"}' : 'Browser will block response'}`;

            showResult('customTestResult', 'info', result);
        }

        async function runAllTests() {
            showResult('bulkTestResult', 'info', 'Running automated tests on server...');

            try {
                const response = await fetch(window.location.origin + '/backend/test_cors.php');
                const text = await response.text();

                showResult('bulkTestResult', 'info', text);
            } catch (error) {
                showResult('bulkTestResult', 'error', `Error: ${error.message}\n\nRun manually: php backend/test_cors.php`);
            }
        }

        // Load origins on page load
        loadAllowedOrigins();
    </script>
</body>

</html>