<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Import 621 Students - Student Data Mining</title>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: #64748b;
            margin-bottom: 2rem;
        }

        .file-input-area {
            border: 3px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            margin-bottom: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-input-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .file-input-area.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        #fileInput {
            display: none;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .progress-container {
            display: none;
            margin-top: 2rem;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f1f5f9;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .log-container {
            max-height: 400px;
            overflow-y: auto;
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }

        .log-entry.success {
            background: #d1fae5;
            color: #065f46;
        }

        .log-entry.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .log-entry.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üéì Full Student Data Import</h1>
        <p class="subtitle">Import all 621 students from Excel file with complete data</p>

        <div class="stats" id="stats" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="studentCount">0</div>
                <div class="stat-label">Students</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="enrollmentCount">0</div>
                <div class="stat-label">Enrollments</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="gradeCount">0</div>
                <div class="stat-label">Grade Entries</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="attendanceCount">0</div>
                <div class="stat-label">Attendance Records</div>
            </div>
        </div>

        <div class="file-input-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
            <input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFileSelect(event)">
            <h3>üìÅ Click to select or drag Excel file here</h3>
            <p>File: 1st 3rd 5th 2025 Attendance sheet.xlsx</p>
        </div>

        <div style="text-align: center; margin-bottom: 2rem;">
            <button class="btn btn-primary" id="importBtn" onclick="startImport()" disabled>
                Start Full Import (621 Students)
            </button>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        let excelData = null;
        let currentPhase = '';

        // Handle file selection
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            log('info', `Reading file: ${file.name}...`);

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    excelData = {
                        sheets: {},
                        sheetNames: workbook.SheetNames
                    };

                    // Read all sheets
                    workbook.SheetNames.forEach(sheetName => {
                        const worksheet = workbook.Sheets[sheetName];
                        excelData.sheets[sheetName] = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    });

                    log('success', `‚úÖ File loaded! Found ${workbook.SheetNames.length} sheets`);
                    log('info', `Sheets: ${workbook.SheetNames.join(', ')}`);

                    document.getElementById('importBtn').disabled = false;
                    document.getElementById('stats').style.display = 'grid';

                } catch (error) {
                    log('error', `‚ùå Error reading file: ${error.message}`);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // Drag and drop handlers
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('active');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('active');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('active');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('fileInput').files = e.dataTransfer.files;
                handleFileSelect({ target: { files: [file] } });
            }
        });

        // Logging function
        function log(type, message) {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }

        // Update progress
        function updateProgress(percent, message) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
            if (message) log('info', message);
        }

        // Update stats
        function updateStats(students, enrollments, grades, attendance) {
            document.getElementById('studentCount').textContent = students || 0;
            document.getElementById('enrollmentCount').textContent = enrollments || 0;
            document.getElementById('gradeCount').textContent = grades || 0;
            document.getElementById('attendanceCount').textContent = attendance || 0;
        }

        // Start import process
        async function startImport() {
            if (!excelData) {
                alert('Please select a file first');
                return;
            }

            document.getElementById('importBtn').disabled = true;
            document.getElementById('progressContainer').style.display = 'block';

            log('info', 'üöÄ Starting full import process...');
            updateProgress(5, 'Processing Excel data...');

            try {
                // Process data from sheets
                const processedData = processExcelData();

                updateProgress(20, `Processed ${processedData.students.length} students from Excel`);

                // Send to PHP backend
                await importStudents(processedData.students);
                updateProgress(50, 'Students imported');

                await importEnrollments(processedData.enrollments);
                updateProgress(70, 'Enrollments created');

                await importGrades(processedData.grades);
                updateProgress(85, 'Grades imported');

                await importAttendance(processedData.attendance);
                updateProgress(100, '‚úÖ Import completed successfully!');

                log('success', `üéâ All done! Imported ${processedData.students.length} students with complete data`);

            } catch (error) {
                log('error', `‚ùå Import failed: ${error.message}`);
                console.error(error);
            }
        }

        // Process Excel data
        function processExcelData() {
            const sheet5th = excelData.sheets['5th'];
            const sheet5thEval = excelData.sheets['5th Evaluation'];

            log('info', 'Processing student data from 5th semester sheet...');

            const students = [];
            const enrollments = [];
            const grades = [];
            const attendance = [];

            // Find header row (row with "Enrollment", "Name", etc.)
            let headerRow = 1; // Usually row index 1
            const headers = sheet5th[headerRow];

            // Process students (skip header rows)
            for (let i = headerRow + 1; i < sheet5th.length; i++) {
                const row = sheet5th[i];
                if (!row || !row[2]) continue; // Skip if no enrollment number

                const enrollment = row[2]?.toString();
                if (!enrollment || isNaN(enrollment)) continue;

                students.push({
                    batch: row[0] || 1,
                    class: row[1] || 'A',
                    enrollment: enrollment,
                    name: row[3] || 'Unknown',
                    coordinator: row[4] || null,
                    mobile1: row[5] || null,
                    mobile2: row[6] || null
                });
            }

            log('success', `Found ${students.length} valid student records`);

            // Create enrollments (7 subjects per student)
            const subjects = ['CPT', 'NS', 'PHP-CGM', 'JAVA', 'PYTHON', 'PRO', 'INE'];
            students.forEach(student => {
                subjects.forEach(subjectCode => {
                    enrollments.push({
                        enrollment: student.enrollment,
                        subjectCode: subjectCode
                    });
                });
            });

            log('info', `Created ${enrollments.length} enrollment records`);

            return {
                students,
                enrollments,
                grades,
                attendance
            };
        }

        // Import students to database
        async function importStudents(students) {
            log('info', `Importing ${students.length} students...`);

            const response = await fetch('import_students_backend.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'import_students', data: students })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            updateStats(result.imported, 0, 0, 0);
            log('success', `‚úÖ Imported ${result.imported} students`);
        }

        // Import enrollments
        async function importEnrollments(enrollments) {
            log('info', `Creating ${enrollments.length} enrollments...`);

            const response = await fetch('import_students_backend.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'import_enrollments', data: enrollments })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error);

            const currentStats = {
                students: parseInt(document.getElementById('studentCount').textContent),
                enrollments: result.imported
            };
            updateStats(currentStats.students, currentStats.enrollments, 0, 0);
            log('success', `‚úÖ Created ${result.imported} enrollments`);
        }

        // Import grades (placeholder for now)
        async function importGrades(grades) {
            log('info', 'Grade import would happen here...');
            // Would process evaluation data from '5th Evaluation' sheet
        }

        // Import attendance (placeholder for now)
        async function importAttendance(attendance) {
            log('info', 'Attendance import would happen here...');
            // Would process daily attendance from date columns
        }
    </script>
</body>

</html>